#!/usr/bin/env ruby
# frozen_string_literal: true

require "bundler/setup"

# Colors for output
class Colors
  RED = "\e[31m"
  GREEN = "\e[32m"
  YELLOW = "\e[33m"
  BLUE = "\e[34m"
  RESET = "\e[0m"
end

def colored_puts(text, color = nil)
  puts color ? "#{color}#{text}#{Colors::RESET}" : text
end

def run_command(cmd, description)
  colored_puts "\nğŸ”„ #{description}...", Colors::BLUE

  success = system(cmd)

  if success
    colored_puts "âœ… #{description} completed successfully", Colors::GREEN
  else
    colored_puts "âŒ #{description} failed", Colors::RED
    exit 1
  end

  success
end

def check_prerequisites
  colored_puts "ğŸ” Checking prerequisites...", Colors::BLUE

  # Check if Bun is installed
  unless system("which bun > /dev/null 2>&1")
    colored_puts "âŒ Bun is not installed. Please install Bun first:",
                 Colors::RED
    colored_puts "   curl -fsSL https://bun.sh/install | bash", Colors::YELLOW
    exit 1
  end

  # Check if universal-renderer NPM package is built
  unless File.exist?("universal-renderer/dist/index.js")
    colored_puts "âŒ universal-renderer NPM package not built. Building now...",
                 Colors::YELLOW
    run_command(
      "cd universal-renderer && bun run build",
      "Building NPM package"
    )
  end

  colored_puts "âœ… Prerequisites checked", Colors::GREEN
end

def main
  colored_puts "ğŸš€ Universal Renderer - Integration Tests", Colors::BLUE
  colored_puts "=" * 50

  check_prerequisites

  # Run Ruby gem unit tests first to ensure basic functionality
  run_command(
    "bundle exec rspec spec/units --format documentation",
    "Running Ruby gem unit tests"
  )

  # Run NPM package unit tests
  run_command(
    "cd universal-renderer && bun test",
    "Running NPM package unit tests"
  )

  # Run integration tests
  run_command(
    "bundle exec rspec spec/integration --format documentation --color",
    "Running integration tests"
  )

  colored_puts "\nğŸ‰ All integration tests completed successfully!",
               Colors::GREEN
  colored_puts "\nğŸ“Š Test Summary:", Colors::BLUE
  colored_puts "   â€¢ Ruby gem unit tests: âœ… Passed"
  colored_puts "   â€¢ NPM package unit tests: âœ… Passed"
  colored_puts "   â€¢ Integration tests: âœ… Passed"
  colored_puts "   â€¢ HTTP contract validation: âœ… Passed"
end

main if __FILE__ == $0
